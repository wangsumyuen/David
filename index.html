<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Firebase èŠå¤©å®¤ Â· åˆ†é è¼‰å…¥ç‰ˆ</title>
    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        .msg-list::-webkit-scrollbar { width: 6px; }
        .msg-list::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        .room-list::-webkit-scrollbar { width: 6px; }
        .room-list::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }

        /* åœ–ç‰‡è¨Šæ¯ */
        .chat-image { max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; }
        .chat-image:hover { opacity: 0.9; }

        /* é ­åƒ */
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        /* æˆ¿é–“é …ç›® */
        .room-item {
            cursor: pointer;
            padding: 1.5rem 1.2rem;
            font-size: 1.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            transition: all 0.2s;
            margin-bottom: 1rem;
            background: white;
        }
        .room-item:hover { background-color: #f7fafc; }
        .room-item.active { background-color: #e0e7ff; border-color: #6366f1; }
        .room-item .room-name { font-size: 1.8rem; font-weight: 500; }
        .room-item .room-id { font-size: 1.4rem; color: #4b5563; margin-top: 0.3rem; }
        .room-item .lock-badge { font-size: 1.4rem; background: #fef3c7; padding: 0.3rem 1rem; border-radius: 9999px; }

        /* åˆªé™¤æŒ‰éˆ• */
        .delete-msg-btn { opacity: 0.3; transition: opacity 0.2s; }
        .delete-msg-btn:hover { opacity: 1; }

        /* æµé‡é¡¯ç¤º */
        .traffic-indicator { font-size: 1.2rem; background: #e2e8f0; padding: 0.4rem 1rem; border-radius: 9999px; color: #2d3748; }

        /* å´é‚Šæ¬„å›ºå®šå¯¬åº¦ */
        #sidebar {
            width: 360px;
            min-width: 360px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        /* æˆ¿é–“åˆ—è¡¨å®¹å™¨ */
        #roomListContainer {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            min-height: 0;
        }

        /* ç®¡ç†å€åŸŸ */
        #roomManageMainArea, #userManageMainArea {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1rem;
            min-height: 0;
        }

        #roomManageList, #userManageList {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
            min-height: 0;
        }

        #roomManageList > div, #userManageList > div {
            margin-bottom: 0.5rem;
        }

        /* èŠå¤©ä¸»å€åŸŸ */
        #chatPage {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .flex-1 {
            flex: 1 1 0%;
            min-height: 0;
        }
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* æ‰‹æ©Ÿå°ˆç”¨æ¨£å¼ */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 96%;
                max-width: 480px;
                background: white;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 2px 0 20px rgba(0,0,0,0.25);
                padding: 1rem;
                height: auto;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
            }
            #sidebar.open { transform: translateX(0); }
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 40;
            }
            .sidebar-overlay.open { display: block; }

            #roomListContainer {
                flex: 1;
                overflow-y: auto;
                max-height: none;
                padding: 0.5rem;
            }

            .room-item {
                padding: 1rem !important;
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem;
            }
            .room-item .room-name { font-size: 1.4rem !important; }
            .room-item .room-id { font-size: 1rem !important; }

            .bg-white.p-3.rounded.shadow {
                padding: 0.75rem !important;
                margin-bottom: 0.5rem;
            }
            #newRoomName, #newRoomPwd, #joinRoomId, #joinRoomPwd {
                padding: 0.5rem !important;
                font-size: 1rem !important;
                margin-bottom: 0.5rem;
            }
            #createRoomBtn, #joinRoomBtn {
                padding: 0.5rem !important;
                font-size: 1rem !important;
            }

            input, button {
                font-size: 1rem;
            }

            #navUsername { font-size: 1.2rem; }
            #adminBadge { font-size: 1rem; }

            #messageInputArea {
                padding: 0.5rem !important;
            }
            #messageInput {
                padding: 0.5rem 0.75rem !important;
                font-size: 1rem !important;
                height: 2.5rem;
            }
            #uploadBtn, #sendBtn, #exportChatBtn {
                width: 2.5rem !important;
                height: 2.5rem !important;
                font-size: 1.2rem !important;
                padding: 0 !important;
            }
        }

        /* é€šç”¨ */
        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; border-radius: 12px; max-width: 400px; width: 90%; padding: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; border: none; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #e5e7eb; color: #1f2937; }
        .btn-secondary:hover { background: #d1d5db; }
        input, select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; }
        .error-text { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

<!-- æ‰‹æ©Ÿå´é‚Šæ¬„é®ç½© -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar(false)"></div>

<!-- ========== ç™»å…¥/è¨»å†Šé é¢ ========== -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl flex flex-col md:flex-row overflow-hidden">
        <div class="bg-gradient-to-br from-indigo-600 to-blue-500 text-white p-8 md:w-1/2 flex flex-col justify-between">
            <div>
                <h2 class="text-3xl font-bold mb-2">Firebase èŠå¤©å®¤</h2>
                <p class="text-indigo-100">ç®¡ç†å“¡: wangsumyuen</p>
                <p class="text-indigo-100 text-sm mt-1">åˆ†é è¼‰å…¥ç‰ˆ Â· è‡ªè¨‚å£ç´™</p>
                <p class="text-indigo-200 text-xs mt-2">æ¯æ¬¡è¼‰å…¥ 20 å‰‡è¨Šæ¯ï¼Œæ»¾å‹•é ‚éƒ¨è¼‰å…¥æ›´å¤š</p>
            </div>
            <div class="text-xs text-indigo-200 mt-6">
                <i class="fas fa-circle-info"></i> ä½¿ç”¨è€…åç¨±ä¸å¯é‡è¤‡ï¼Œå¯†ç¢¼ä¸å¯å«ç©ºæ ¼
            </div>
        </div>
        <div class="p-8 md:w-1/2 bg-white">
            <div class="flex border-b border-gray-200 mb-6">
                <button id="loginTabBtn" class="flex-1 pb-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 transition">ç™»å…¥</button>
                <button id="registerTabBtn" class="flex-1 pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition">è¨»å†Š</button>
            </div>
            <div id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm text-gray-600 mb-1"><i class="fas fa-user mr-1"></i>ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="loginUsername" placeholder="ä¾‹å¦‚: wangsumyuen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none login-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1"><i class="fas fa-lock mr-1"></i>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none login-input">
                </div>
                <button id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition shadow text-lg">ç™» å…¥</button>
                <div id="loginError" class="error-text"></div>
            </div>
            <div id="registerForm" class="space-y-5 hidden">
                <div>
                    <label class="block text-sm text-gray-600 mb-1"><i class="fas fa-user-plus mr-1"></i>ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="regUsername" placeholder="ä½¿ç”¨è€…åç¨± (ä¸å¯åŒ…å«ç©ºæ ¼)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none login-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1"><i class="fas fa-lock mr-1"></i>å¯†ç¢¼</label>
                    <input type="password" id="regPassword" placeholder="å¯†ç¢¼ (ä¸å¯åŒ…å«ç©ºæ ¼)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none login-input">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1"><i class="fas fa-image mr-1"></i>é ­åƒ (å¯é¸)</label>
                    <div class="flex items-center space-x-3">
                        <input type="file" id="regAvatarInput" accept="image/png, image/jpeg, image/gif, image/webp" class="hidden">
                        <button id="regAvatarBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg text-sm transition flex items-center">
                            <i class="fas fa-upload mr-2"></i>é¸æ“‡åœ–ç‰‡
                        </button>
                        <span id="avatarFileName" class="text-xs text-gray-500">æœªé¸æ“‡æª”æ¡ˆ</span>
                    </div>
                    <div id="avatarPreviewContainer" class="mt-2 hidden">
                        <img id="avatarPreviewImg" src="#" alt="é è¦½" class="avatar border border-gray-300">
                    </div>
                </div>
                <button id="registerBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition shadow text-lg">è¨» å†Š</button>
                <div id="registerError" class="error-text"></div>
            </div>
            <div id="loginMessage" class="mt-4 text-sm text-center h-5 text-red-500"></div>
        </div>
    </div>
</div>

<!-- ========== ä¸»èŠå¤©ä»‹é¢ ========== -->
<div id="chatPage" class="hidden h-screen flex flex-col bg-gray-50">
    <header class="bg-white border-b border-gray-200 py-3 px-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center space-x-2">
            <button id="menuToggleBtn" class="md:hidden text-gray-600 hover:text-indigo-600 p-2 rounded-full transition" title="é¸å–®"><i class="fas fa-bars"></i></button>
            <i class="fas fa-comments text-indigo-600 text-xl hidden sm:inline"></i>
            <h1 class="text-xl font-semibold text-gray-800 hidden sm:inline">å³æ™‚èŠå¤©å®¤</h1>
            <span id="currentUserBadge" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                <img id="navAvatar" src="" class="avatar-sm hidden" alt="">
                <span id="navUsername"></span>
            </span>
            <span id="adminBadge" class="hidden bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-crown mr-1"></i>ç®¡ç†å“¡</span>
        </div>
        <div class="flex items-center space-x-2">
            <span id="trafficDisplay" class="traffic-indicator hidden sm:inline-block" title="æœ¬å·¥ä½œéšæ®µæµé‡ (ç™¼é€/æ¥æ”¶)">ğŸ“¤ 0KB ğŸ“¥ 0KB</span>
            <button id="editProfileBtn" class="text-gray-600 hover:text-indigo-600 p-2 rounded-full transition" title="ä¿®æ”¹è³‡æ–™"><i class="fas fa-cog"></i></button>
            <button id="logoutBtn" class="flex items-center text-sm text-gray-600 hover:text-indigo-600 transition"><i class="fas fa-sign-out-alt mr-2"></i> ç™»å‡º</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- å·¦å´æˆ¿é–“åˆ—è¡¨ (å´é‚Šæ¬„) -->
        <aside id="sidebar" class="bg-white border-r border-gray-200 flex flex-col overflow-hidden md:block mobile-sidebar">
            <div class="bg-yellow-50 border-b border-yellow-200 p-2 text-xs text-yellow-800 flex items-center">
                <i class="fas fa-info-circle mr-1 flex-shrink-0"></i>
                <span>ç‹å¿ƒé (David)èŠå¤©å®¤ Â· åˆ†é è¼‰å…¥</span>
            </div>
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <p class="text-xs text-gray-500 uppercase tracking-wider">æˆ¿é–“åˆ—è¡¨</p>
                    <div id="adminRoomToggle" class="hidden space-x-1 text-xs">
                        <button id="showMyRoomsBtn" class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded transition">æˆ‘çš„æˆ¿é–“</button>
                        <button id="showAllRoomsBtn" class="px-2 py-1 bg-gray-100 text-gray-700 rounded transition">æ‰€æœ‰æˆ¿é–“</button>
                    </div>
                </div>
                <p id="roomListHint" class="text-sm text-gray-700 truncate mt-1"></p>
            </div>
            <!-- æˆ¿é–“åˆ—è¡¨å®¹å™¨ -->
            <div class="flex-1 overflow-y-auto room-list p-3 space-y-2" id="roomListContainer"></div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 space-y-3">
                <div class="bg-white p-3 rounded-lg shadow-sm">
                    <h3 class="text-sm font-medium text-gray-700 mb-2"><i class="fas fa-plus-circle text-indigo-500 mr-1"></i>å»ºç«‹æˆ¿é–“</h3>
                    <input type="text" id="newRoomName" placeholder="æˆ¿é–“åç¨±" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-lg mb-2 focus:ring-1 focus:ring-indigo-200">
                    <div class="flex items-center mb-2">
                        <input type="text" id="newRoomPwd" placeholder="åŠ å¯†å¯†ç¢¼ (å¯é¸)" class="flex-1 text-sm px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-1 focus:ring-indigo-200">
                        <span class="bg-gray-100 px-3 py-2 text-gray-500 text-xs border-t border-b border-r border-gray-300 rounded-r-lg"><i class="fas fa-lock"></i></span>
                    </div>
                    <button id="createRoomBtn" class="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-sm font-medium py-2 rounded-lg transition">å»ºç«‹æˆ¿é–“</button>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm">
                    <h3 class="text-sm font-medium text-gray-700 mb-2"><i class="fas fa-door-open text-emerald-500 mr-1"></i>é€éç·¨è™Ÿé€²å…¥</h3>
                    <div class="flex items-stretch">
                        <input type="text" id="joinRoomId" placeholder="æˆ¿é–“ç·¨è™Ÿ" class="flex-1 text-sm px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-1 focus:ring-indigo-200">
                        <button id="joinRoomBtn" class="bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-4 py-2 text-sm rounded-r-lg transition"><i class="fas fa-arrow-right-to-bracket"></i></button>
                    </div>
                    <div class="mt-2">
                        <input type="password" id="joinRoomPwd" placeholder="å¯†ç¢¼ (ç®¡ç†å“¡ä¸éœ€è¦)" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-200">
                    </div>
                </div>
            </div>
        </aside>

        <!-- å³å´ä¸»å€åŸŸ -->
        <main class="flex-1 flex flex-col bg-gray-50 transition-all duration-300">
            <div class="bg-white px-6 py-2 border-b border-gray-200 flex justify-between items-center">
                <div id="mainTabs" class="flex space-x-4">
                    <button id="chatMainTabBtn" class="py-2 px-1 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 transition">èŠå¤©</button>
                    <button id="roomManageMainTabBtn" class="py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition hidden">æˆ¿é–“ç®¡ç†</button>
                    <button id="userManageMainTabBtn" class="py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition hidden">ä½¿ç”¨è€…ç®¡ç†</button>
                </div>
                <div id="currentRoomHeader" class="text-sm text-gray-600">
                    <span id="currentRoomName" class="font-semibold text-gray-800">æœªé¸æ“‡æˆ¿é–“</span>
                    <span id="currentRoomIdSpan" class="text-xs bg-gray-200 text-gray-600 ml-2 px-2 py-1 rounded-md"></span>
                    <span id="roomLockBadge" class="hidden ml-2 text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-md"><i class="fas fa-lock"></i> åŠ å¯†</span>
                </div>
            </div>

            <!-- èŠå¤©ä¸»å€åŸŸ -->
            <div id="chatMainArea" class="flex-1 flex flex-col">
                <div class="bg-white px-6 py-1 border-b border-gray-200 flex space-x-4">
                    <button id="chatSubTabBtn" class="sub-tab py-1 px-2 text-xs font-medium text-indigo-600 border-b-2 border-indigo-600">è¨Šæ¯</button>
                    <button id="memberSubTabBtn" class="sub-tab py-1 px-2 text-xs font-medium text-gray-500 hover:text-gray-700 transition hidden">æˆå“¡</button>
                </div>
                <div id="messageArea" class="flex-1 flex flex-col">
                    <!-- è¨Šæ¯åˆ—è¡¨å®¹å™¨ï¼ˆèƒŒæ™¯å°‡å¥—ç”¨å£ç´™ï¼‰ -->
                    <div id="messageList" class="flex-1 overflow-y-auto p-4 space-y-3 msg-list" style="background: #f9fafb;"></div>
                    <div id="messageInputArea" class="bg-white px-6 py-4 border-t border-gray-200 flex items-center space-x-2">
                        <input type="file" id="imageUploadInput" accept="image/png, image/jpeg, image/gif, image/webp" class="hidden">
                        <button id="uploadBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2.5 rounded-full w-10 h-10 flex items-center justify-center transition disabled:opacity-50 disabled:cursor-not-allowed" title="ä¸Šå‚³åœ–ç‰‡" disabled><i class="fas fa-image"></i></button>
                        <button id="exportChatBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2.5 rounded-full w-10 h-10 flex items-center justify-center transition disabled:opacity-50 disabled:cursor-not-allowed" title="åŒ¯å‡ºèŠå¤©è¨˜éŒ„" disabled><i class="fas fa-download"></i></button>
                        <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." class="flex-1 px-4 py-2.5 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-200" disabled>
                        <button id="sendBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-full w-10 h-10 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                <div id="memberArea" class="flex-1 hidden flex-col p-4 overflow-y-auto">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-users mr-2"></i>æˆ¿é–“æˆå“¡</h2>
                    <div id="memberListContainer" class="space-y-2"></div>
                </div>
            </div>

            <!-- æˆ¿é–“ç®¡ç†ä¸»å€åŸŸ -->
            <div id="roomManageMainArea" class="flex-1 hidden flex-col overflow-hidden p-4">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center"><i class="fas fa-door-open mr-2"></i>æ‰€æœ‰æˆ¿é–“</h2>
                    <button id="addRoomBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded-lg transition"><i class="fas fa-plus-circle mr-1"></i>æ–°å¢æˆ¿é–“</button>
                </div>
                <div class="mb-3 flex-shrink-0">
                    <input type="text" id="roomManageSearch" placeholder="æœå°‹æˆ¿é–“åç¨±æˆ–ID..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-200">
                </div>
                <div id="roomManageList" class="space-y-2 overflow-y-auto pr-1"></div>
            </div>

            <!-- ä½¿ç”¨è€…ç®¡ç†ä¸»å€åŸŸ -->
            <div id="userManageMainArea" class="flex-1 hidden flex-col overflow-hidden p-4">
                <div id="adminConfigContainer" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">å…è¨±ä¸€èˆ¬ä½¿ç”¨è€…è¨»å†Šç®¡ç†å“¡åç¨± (wangsumyuen)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="allowAdminNameCheckbox" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center"><i class="fas fa-users mr-2"></i>æ‰€æœ‰è¨»å†Šä½¿ç”¨è€…</h2>
                    <button id="addUserBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded-lg transition"><i class="fas fa-user-plus mr-1"></i>æ–°å¢ä½¿ç”¨è€…</button>
                </div>
                <div class="mb-3 flex-shrink-0">
                    <input type="text" id="userManageSearch" placeholder="æœå°‹ä½¿ç”¨è€…åç¨±..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-200">
                </div>
                <div id="userManageList" class="space-y-2 overflow-y-auto pr-1"></div>
            </div>
        </main>
    </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="this.classList.add('hidden')">
    <img id="modalImage" src="" alt="é è¦½" class="max-w-full max-h-full rounded-lg shadow-2xl">
</div>

<!-- ä¿®æ”¹è³‡æ–™æ¨¡æ…‹æ¡† (å·²åŠ å…¥å£ç´™è¨­å®š) -->
<div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-edit mr-2 text-indigo-600"></i>ä¿®æ”¹è³‡æ–™</h3>
        <div class="space-y-4">
            <!-- é ­åƒå€ -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">ç›®å‰é ­åƒ</label>
                <img id="profileCurrentAvatar" src="" class="avatar border border-gray-300 mb-2">
                <label class="block text-sm text-gray-600 mb-1">æ–°é ­åƒ (å¯é¸)</label>
                <input type="file" id="profileAvatarInput" accept="image/png, image/jpeg, image/gif, image/webp" class="block w-full text-sm border border-gray-300 rounded-lg p-1">
            </div>
            <!-- ä½¿ç”¨è€…åç¨± -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">æ–°ä½¿ç”¨è€…åç¨±</label>
                <input type="text" id="profileNewUsername" placeholder="æ–°åç¨± (ç•™ç©ºå‰‡ä¸ä¿®æ”¹)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
                <p id="profileUsernameMessage" class="text-xs text-red-500 h-4"></p>
            </div>
            <!-- å¯†ç¢¼ä¿®æ”¹ -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">åŸå¯†ç¢¼</label>
                <input type="password" id="profileOldPwd" placeholder="è¼¸å…¥åŸå¯†ç¢¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">æ–°å¯†ç¢¼</label>
                <input type="password" id="profileNewPwd" placeholder="ç•™ç©ºå‰‡ä¸ä¿®æ”¹" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">ç¢ºèªæ–°å¯†ç¢¼</label>
                <input type="password" id="profileConfirmPwd" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none">
            </div>
            <!-- æ–°å¢ï¼šèŠå¤©èƒŒæ™¯è¨­å®š -->
            <div class="border-t border-gray-200 pt-4 mt-2">
                <h4 class="text-md font-medium text-gray-800 mb-3 flex items-center"><i class="fas fa-palette mr-2 text-purple-500"></i>èŠå¤©èƒŒæ™¯è¨­å®š</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">é¸æ“‡é¡è‰²</label>
                        <input type="color" id="profileWallpaperColor" class="w-full h-10 p-1 border border-gray-300 rounded-lg cursor-pointer">
                    </div>
                    <div class="text-center text-sm text-gray-400">æˆ–</div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</label>
                        <input type="file" id="profileWallpaperImage" accept="image/png, image/jpeg, image/gif, image/webp" class="block w-full text-sm border border-gray-300 rounded-lg p-1">
                        <p class="text-xs text-gray-500 mt-1">å»ºè­°åœ–ç‰‡å°æ–¼ 200KBï¼Œæœƒè‡ªå‹•å£“ç¸®</p>
                    </div>
                    <div>
                        <button id="clearWallpaperBtn" class="text-xs text-red-600 hover:text-red-800"><i class="fas fa-undo-alt mr-1"></i>æ¢å¾©é è¨­èƒŒæ™¯</button>
                    </div>
                </div>
            </div>
            <!-- æŒ‰éˆ•å€ -->
            <div class="flex justify-end space-x-3 pt-2">
                <button id="profileCancelBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">å–æ¶ˆ</button>
                <button id="profileSaveBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition">å„²å­˜ä¿®æ”¹</button>
            </div>
            <div id="profileMessage" class="text-sm text-center text-red-500 h-5"></div>
        </div>
    </div>
</div>

<!-- æ–°å¢æˆ¿é–“æ¨¡æ…‹æ¡† -->
<div id="addRoomModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-plus-circle mr-2 text-green-600"></i>æ–°å¢æˆ¿é–“</h3>
        <div class="space-y-4">
            <div><label class="block text-sm text-gray-600 mb-1">æˆ¿é–“åç¨±</label><input type="text" id="addRoomName" placeholder="æˆ¿é–“åç¨±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div><label class="block text-sm text-gray-600 mb-1">å¯†ç¢¼ (å¯é¸)</label><input type="text" id="addRoomPwd" placeholder="åŠ å¯†å¯†ç¢¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div class="flex justify-end space-x-3 pt-2"><button id="addRoomCancelBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">å–æ¶ˆ</button><button id="addRoomSaveBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">å»ºç«‹æˆ¿é–“</button></div>
            <div id="addRoomMessage" class="text-sm text-center text-red-500 h-5"></div>
        </div>
    </div>
</div>

<!-- æ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡† -->
<div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-plus mr-2 text-green-600"></i>æ–°å¢ä½¿ç”¨è€…</h3>
        <div class="space-y-4">
            <div><label class="block text-sm text-gray-600 mb-1">ä½¿ç”¨è€…åç¨±</label><input type="text" id="addUsername" placeholder="ä½¿ç”¨è€…åç¨±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div><label class="block text-sm text-gray-600 mb-1">å¯†ç¢¼</label><input type="password" id="addPassword" placeholder="å¯†ç¢¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div><label class="block text-sm text-gray-600 mb-1">é ­åƒ (å¯é¸)</label><input type="file" id="addAvatarInput" accept="image/png, image/jpeg, image/gif, image/webp" class="block w-full text-sm border border-gray-300 rounded-lg p-1"><div id="addAvatarPreviewContainer" class="mt-2 hidden"><img id="addAvatarPreview" src="#" class="avatar border border-gray-300"></div></div>
            <div class="flex justify-end space-x-3 pt-2"><button id="addUserCancelBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">å–æ¶ˆ</button><button id="addUserSaveBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">å»ºç«‹ä½¿ç”¨è€…</button></div>
            <div id="addUserMessage" class="text-sm text-center text-red-500 h-5"></div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æˆ¿é–“æ¨¡æ…‹æ¡† -->
<div id="editRoomModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-edit mr-2 text-indigo-600"></i>ç·¨è¼¯æˆ¿é–“</h3>
        <div class="space-y-4">
            <div><label class="block text-sm text-gray-600 mb-1">æˆ¿é–“åç¨±</label><input type="text" id="editRoomName" placeholder="æˆ¿é–“åç¨±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div><label class="block text-sm text-gray-600 mb-1">å¯†ç¢¼ (ç•™ç©ºè¡¨ç¤ºä¸åŠ å¯†)</label><input type="text" id="editRoomPwd" placeholder="æ–°å¯†ç¢¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"></div>
            <div class="flex justify-end space-x-3 pt-2"><button id="editRoomCancelBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">å–æ¶ˆ</button><button id="editRoomSaveBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition">å„²å­˜</button></div>
            <div id="editRoomMessage" class="text-sm text-center text-red-500 h-5"></div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯ä½¿ç”¨è€…æ¨¡æ…‹æ¡† -->
<div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-edit mr-2 text-indigo-600"></i>ç·¨è¼¯ä½¿ç”¨è€…</h3>
        <div class="space-y-4">
            <div><label class="block text-sm text-gray-600 mb-1">ç›®å‰é ­åƒ</label><img id="editUserCurrentAvatar" src="" class="avatar border border-gray-300 mb-2"><label class="block text-sm text-gray-600 mb-1">æ–°é ­åƒ (å¯é¸)</label><input type="file" id="editUserAvatarInput" accept="image/png, image/jpeg, image/gif, image/webp" class="block w-full text-sm border border-gray-300 rounded-lg p-1"></div>
            <div><label class="block text-sm text-gray-600 mb-1">å±è”½ç‹€æ…‹</label><select id="editUserBanned" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none"><option value="false">æ­£å¸¸</option><option value="true">å·²å±è”½</option></select></div>
            <div class="flex justify-end space-x-3 pt-2"><button id="editUserCancelBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">å–æ¶ˆ</button><button id="editUserSaveBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition">å„²å­˜ä¿®æ”¹</button></div>
            <div id="editUserMessage" class="text-sm text-center text-red-500 h-5"></div>
        </div>
    </div>
</div>

<script>
(function() {
    "use strict";

    // ========== Firebase é…ç½® ==========
    const firebaseConfig = {
        apiKey: "AIzaSyAkTjnZhuBxT6GthD0qOLi7mjsGzMKOwV0",
        authDomain: "david-cloud-chat.firebaseapp.com",
        databaseURL: "https://david-cloud-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "david-cloud-chat",
        storageBucket: "david-cloud-chat.firebasestorage.app",
        messagingSenderId: "281013748690",
        appId: "1:281013748690:web:ff39c75d751b15162a3e0b"
    };
    // ===================================

    let firebaseReady = false;
    let auth, database;

    try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        firebaseReady = true;
        console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
        const loginMsg = document.getElementById('loginMessage');
        if (loginMsg) loginMsg.innerText = 'Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®æˆ–ç¶²è·¯';
        alert('Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é…ç½®ã€‚');
    }

    function checkFirebaseReady() {
        if (!firebaseReady) {
            alert('Firebase æœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            return false;
        }
        return true;
    }

    // ---------- å…¨åŸŸè®Šæ•¸ ----------
    let currentUser = null;
    let currentRoomId = null;
    let adminRoomViewMode = 'my';
    let currentMainTab = 'chat';
    let currentChatSubTab = 'message';
    let currentMessageListener = null;
    let sentBytes = 0;
    let receivedBytes = 0;
    const KB = 1024;
    let lastMessageTime = 0;
    const MIN_INTERVAL = 1000;
    const userCache = {};
    const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23cbd5e0'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='%234a5568' font-family='Arial'%3EğŸ‘¤%3C/text%3E%3C/svg%3E";
    const DEFAULT_WALLPAPER = '#f9fafb';

    // ---------- åˆ†é è¼‰å…¥ç›¸é—œè®Šæ•¸ ----------
    const MESSAGE_LIMIT = 20;
    let lastMessageKey = null;
    let hasMoreMessages = true;
    let loadingMore = false;
    let messageListScrollListener = null;

    // ---------- å·¥å…·å‡½å¼ ----------
    function escapeHtml(text) {
        if (!text) return '';
        return String(text).replace(/[&<>"]/g, c => {
            if (c === '&') return '&amp;';
            if (c === '<') return '&lt;';
            if (c === '>') return '&gt;';
            if (c === '"') return '&quot;';
            return c;
        });
    }

    function updateTrafficDisplay() {
        const sentKB = (sentBytes / KB).toFixed(1);
        const recvKB = (receivedBytes / KB).toFixed(1);
        const el = document.getElementById('trafficDisplay');
        if (el) el.innerText = `ğŸ“¤ ${sentKB}KB ğŸ“¥ ${recvKB}KB`;
    }

    function generateShortId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // å£“ç¸®åœ–ç‰‡ï¼ˆå¢åŠ éŒ¯èª¤è™•ç†ï¼‰
    function compressImage(file, maxSizeKB = 50) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    const maxDimension = 600;
                    if (width > height && width > maxDimension) {
                        height *= maxDimension / width;
                        width = maxDimension;
                    } else if (height > maxDimension) {
                        width *= maxDimension / height;
                        height = maxDimension;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            reject(new Error('åœ–ç‰‡å£“ç¸®å¤±æ•—'));
                            return;
                        }
                        if (blob.size > maxSizeKB * 1024) {
                            canvas.toBlob((blob2) => resolve(blob2), 'image/jpeg', 0.4);
                        } else {
                            resolve(blob);
                        }
                    }, 'image/jpeg', 0.6);
                };
                img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
            };
            reader.onerror = reject;
        });
    }

    async function getUserData(uid) {
        if (!firebaseReady) return { username: '??', avatar: DEFAULT_AVATAR };
        if (userCache[uid]) return userCache[uid];
        const snap = await database.ref('users/' + uid).once('value');
        const data = snap.val();
        if (data) {
            userCache[uid] = { username: data.username, avatar: data.avatar || DEFAULT_AVATAR, wallpaper: data.wallpaper || null };
            return userCache[uid];
        }
        return { username: '??', avatar: DEFAULT_AVATAR };
    }

    function updateUserCache(uid, newData) {
        if (userCache[uid]) Object.assign(userCache[uid], newData);
        else userCache[uid] = newData;
    }

    // å¥—ç”¨èŠå¤©èƒŒæ™¯
    function applyChatWallpaper() {
        const messageList = document.getElementById('messageList');
        if (!messageList) return;
        if (currentUser && currentUser.wallpaper) {
            if (currentUser.wallpaper.startsWith('data:image') || currentUser.wallpaper.startsWith('http')) {
                messageList.style.background = `url('${currentUser.wallpaper}') center/cover no-repeat fixed`;
            } else {
                messageList.style.background = currentUser.wallpaper;
            }
        } else {
            messageList.style.background = DEFAULT_WALLPAPER;
        }
    }

    async function refreshAllMessages() {
        if (!currentRoomId || !firebaseReady) return;
        const container = document.getElementById('messageList');
        const messages = Array.from(container.children);
        for (let msgDiv of messages) {
            const uid = msgDiv.dataset.uid;
            if (uid) {
                const userData = await getUserData(uid);
                const nameSpan = msgDiv.querySelector('.msg-username');
                if (nameSpan) nameSpan.innerText = userData.username;
                const avatarImg = msgDiv.querySelector('.avatar-sm');
                if (avatarImg) avatarImg.src = userData.avatar;
            }
        }
    }

    // ---------- é…ç½®ç®¡ç† ----------
    async function getAdminConfig() {
        if (!firebaseReady) return true;
        const snap = await database.ref('config/allowAdminNameForUsers').once('value');
        return snap.exists() ? snap.val() : true;
    }

    async function setAdminConfig(value) {
        if (!firebaseReady || !currentUser?.isAdmin) return { success: false, msg: 'æ¬Šé™ä¸è¶³' };
        await database.ref('config/allowAdminNameForUsers').set(value);
        return { success: true };
    }

    // ---------- è¨»å†Šï¼ˆå¢å¼·éŒ¯èª¤è™•ç†ï¼‰----------
    async function registerUser(username, password, avatarBase64) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦' };
        if (!username || !password) return { success: false, msg: 'è«‹å¡«å¯«ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼' };
        if (username.includes(' ') || password.includes(' ')) {
            return { success: false, msg: 'ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼ä¸å¯åŒ…å«ç©ºæ ¼' };
        }
        if (password.length < 6) return { success: false, msg: 'å¯†ç¢¼é•·åº¦è‡³å°‘ç‚º6å€‹å­—å…ƒ' };

        const allowAdminName = await getAdminConfig();
        if (username === 'wangsumyuen' && !allowAdminName) {
            return { success: false, msg: 'ç®¡ç†å“¡åç¨±ç›®å‰ä¸å…è¨±è¨»å†Š' };
        }

        const email = username + '@chat.local';
        
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('è¨»å†Šæ“ä½œé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š')), 15000);
        });

        try {
            const userCred = await Promise.race([
                auth.createUserWithEmailAndPassword(email, password),
                timeoutPromise
            ]);
            
            const uid = userCred.user.uid;

            await database.ref('users/' + uid).set({
                username: username,
                avatar: avatarBase64 || DEFAULT_AVATAR,
                createdAt: new Date().toISOString(),
                isAdmin: false,
                banned: false,
                wallpaper: null
            });

            userCache[uid] = { username, avatar: avatarBase64 || DEFAULT_AVATAR, wallpaper: null };
            return { success: true, msg: 'è¨»å†ŠæˆåŠŸ' };
        } catch (error) {
            console.error('è¨»å†ŠéŒ¯èª¤è©³ç´°è³‡è¨Š:', error);
            let msg = error.message;

            if (error.code === 'auth/email-already-in-use') {
                msg = 'æ­¤ä½¿ç”¨è€…åç¨±å·²è¢«è¨»å†Š';
            } else if (error.code === 'auth/weak-password') {
                msg = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨è‡³å°‘6ä½å­—å…ƒ';
            } else if (error.code === 'auth/invalid-email') {
                msg = 'ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ï¼ˆå…§éƒ¨éŒ¯èª¤ï¼‰';
            } else if (error.code === 'auth/network-request-failed') {
                msg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦';
            } else if (error.message.includes('permission_denied') || error.message.includes('Permission denied')) {
                msg = 'è³‡æ–™åº«æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firebase è¦å‰‡';
            } else if (error.message.includes('é€¾æ™‚')) {
                msg = error.message;
            } else if (error.message.includes('picture')) {
                msg = 'åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            }

            return { success: false, msg };
        }
    }

    // ---------- ç™»å…¥ ----------
    async function loginUser(username, password) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        const email = username + '@chat.local';
        try {
            const userCred = await auth.signInWithEmailAndPassword(email, password);
            const uid = userCred.user.uid;
            const snapshot = await database.ref('users/' + uid).once('value');
            let userData = snapshot.val();
            if (!userData) {
                userData = {
                    username: username,
                    avatar: DEFAULT_AVATAR,
                    createdAt: new Date().toISOString(),
                    isAdmin: false,
                    banned: false,
                    wallpaper: null
                };
                await database.ref('users/' + uid).set(userData);
            }
            if (userData.banned) return { success: false, msg: 'è©²å¸³è™Ÿå·²è¢«å±è”½ï¼Œç„¡æ³•ç™»å…¥' };
            userCache[uid] = { username: userData.username, avatar: userData.avatar || DEFAULT_AVATAR, wallpaper: userData.wallpaper || null };
            return { success: true, user: { ...userData, uid } };
        } catch (error) {
            console.error('ç™»å…¥éŒ¯èª¤:', error);
            let msg = 'ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤';
            if (error.code === 'auth/user-not-found') msg = 'ä½¿ç”¨è€…åç¨±ä¸å­˜åœ¨';
            else if (error.code === 'auth/wrong-password') msg = 'å¯†ç¢¼éŒ¯èª¤';
            else if (error.code === 'auth/too-many-requests') msg = 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
            else if (error.code === 'auth/network-request-failed') msg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦';
            return { success: false, msg };
        }
    }

    // ---------- å–å¾—æ‰€æœ‰ä½¿ç”¨è€… ----------
    async function getAllUsers() {
        if (!firebaseReady) return [];
        const snapshot = await database.ref('users').once('value');
        const users = [];
        snapshot.forEach(child => {
            const u = child.val();
            u.uid = child.key;
            delete u.password;
            users.push(u);
        });
        console.log('getAllUsers å–å¾—ä½¿ç”¨è€…æ•¸é‡:', users.length);
        return users;
    }

    // ---------- ä½¿ç”¨è€…ä¿®æ”¹è³‡æ–™ (åŒ…å«å£ç´™) ----------
    async function updateUserProfile(uid, oldPwd, newUsername, newPwd, newAvatar, newWallpaper) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        const user = auth.currentUser;
        if (!user) return { success: false, msg: 'æœªç™»å…¥' };
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPwd);
            await user.reauthenticateWithCredential(credential);
        } catch (e) {
            return { success: false, msg: 'åŸå¯†ç¢¼éŒ¯èª¤' };
        }
        if (newUsername && newUsername !== currentUser.username) {
            const usersSnap = await database.ref('users').orderByChild('username').equalTo(newUsername).once('value');
            if (usersSnap.exists()) return { success: false, msg: 'ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨' };
        }
        if (newPwd) {
            try {
                await user.updatePassword(newPwd);
            } catch (e) {
                return { success: false, msg: e.message };
            }
        }
        const updates = {};
        if (newUsername) updates.username = newUsername;
        if (newAvatar) updates.avatar = newAvatar;
        if (newWallpaper !== undefined) updates.wallpaper = newWallpaper;
        if (Object.keys(updates).length > 0) {
            await database.ref('users/' + uid).update(updates);
        }
        if (newUsername) updateUserCache(uid, { username: newUsername });
        if (newAvatar) updateUserCache(uid, { avatar: newAvatar });
        if (newWallpaper !== undefined) updateUserCache(uid, { wallpaper: newWallpaper });
        const snap = await database.ref('users/' + uid).once('value');
        const updatedUser = snap.val();
        if (newUsername) refreshAllMessages();
        return { success: true, user: { ...updatedUser, uid } };
    }

    // ---------- ç®¡ç†å“¡æ›´æ–°ä½¿ç”¨è€… ----------
    async function updateUserByAdmin(targetUid, newAvatar, banned) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        const targetSnap = await database.ref('users/' + targetUid).once('value');
        const targetUser = targetSnap.val();
        if (!targetUser) return { success: false, msg: 'ä½¿ç”¨è€…ä¸å­˜åœ¨' };
        if (targetUser.username === 'wangsumyuen') return { success: false, msg: 'ä¸èƒ½ä¿®æ”¹å…§å»ºç®¡ç†å“¡' };
        if (currentUser && currentUser.uid === targetUid) return { success: false, msg: 'ä¸èƒ½ä¿®æ”¹è‡ªå·± (è«‹ä½¿ç”¨è³‡æ–™ä¿®æ”¹)' };
        const updates = {};
        if (newAvatar !== undefined) updates.avatar = newAvatar;
        if (banned !== undefined) updates.banned = banned;
        await database.ref('users/' + targetUid).update(updates);
        if (newAvatar) updateUserCache(targetUid, { avatar: newAvatar });
        return { success: true };
    }

    // ---------- ç®¡ç†å“¡åˆªé™¤ä½¿ç”¨è€… ----------
    async function deleteUserByAdmin(targetUid) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        if (targetUid === currentUser.uid) return { success: false, msg: 'ä¸èƒ½åˆªé™¤è‡ªå·±' };
        const targetSnap = await database.ref('users/' + targetUid).once('value');
        const targetUser = targetSnap.val();
        if (!targetUser) return { success: false, msg: 'ä½¿ç”¨è€…ä¸å­˜åœ¨' };
        if (targetUser.username === 'wangsumyuen') return { success: false, msg: 'ä¸èƒ½åˆªé™¤å…§å»ºç®¡ç†å“¡' };
        
        await database.ref('users/' + targetUid).remove();
        const roomUsersSnap = await database.ref('roomUsers').once('value');
        const updates = {};
        roomUsersSnap.forEach(roomChild => {
            if (roomChild.hasChild(targetUid)) {
                updates[`roomUsers/${roomChild.key}/${targetUid}`] = null;
            }
        });
        await database.ref().update(updates);
        const messagesSnap = await database.ref('messages').once('value');
        const msgUpdates = {};
        messagesSnap.forEach(roomMsgs => {
            roomMsgs.forEach(msg => {
                if (msg.val().uid === targetUid) {
                    msgUpdates[`messages/${roomMsgs.key}/${msg.key}`] = null;
                }
            });
        });
        await database.ref().update(msgUpdates);
        delete userCache[targetUid];
        return { success: true };
    }

    // ---------- åˆªé™¤è¨Šæ¯ ----------
    async function deleteMessage(roomId, messageId) {
        if (!firebaseReady) return;
        await database.ref(`messages/${roomId}/${messageId}`).remove();
    }

    // ---------- åŒ¯å‡ºèŠå¤©è¨˜éŒ„ ----------
    async function exportRoomMessages(roomId) {
        if (!firebaseReady) return alert('Firebase æœªåˆå§‹åŒ–');
        const snapshot = await database.ref('messages/' + roomId).once('value');
        const messages = [];
        snapshot.forEach(child => messages.push(child.val()));
        if (!messages.length) return alert('ç›®å‰æˆ¿é–“æ²’æœ‰è¨Šæ¯å¯åŒ¯å‡º');
        const roomSnap = await database.ref('rooms/' + roomId).once('value');
        const room = roomSnap.val();
        const roomName = room ? room.name : roomId;
        const dataStr = JSON.stringify(messages, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_${roomName}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ---------- å–å¾—æˆ¿é–“æˆå“¡ ----------
    async function getRoomMembers(roomId) {
        if (!firebaseReady) return [];
        const roomUsersSnap = await database.ref('roomUsers/' + roomId).once('value');
        const uids = [];
        roomUsersSnap.forEach(child => uids.push(child.key));
        const members = [];
        for (let uid of uids) {
            const userData = await getUserData(uid);
            members.push({ uid, ...userData });
        }
        return members;
    }

    // ---------- å–å¾—ä½¿ç”¨è€…å¯å­˜å–çš„æˆ¿é–“ ----------
    async function getAccessibleRoomsForUser(uid) {
        if (!firebaseReady) return [];
        const roomUsersSnap = await database.ref('roomUsers').once('value');
        const roomIds = [];
        roomUsersSnap.forEach(roomChild => {
            if (roomChild.hasChild(uid)) {
                roomIds.push(roomChild.key);
            }
        });
        if (roomIds.length === 0) return [];
        const rooms = [];
        for (let id of roomIds) {
            const roomSnap = await database.ref('rooms/' + id).once('value');
            if (roomSnap.exists()) rooms.push(roomSnap.val());
        }
        return rooms;
    }

    // ---------- å–å¾—æ‰€æœ‰æˆ¿é–“ ----------
    async function getAllRooms() {
        if (!firebaseReady) return [];
        const snapshot = await database.ref('rooms').once('value');
        const rooms = [];
        snapshot.forEach(child => {
            rooms.push(child.val());
        });
        console.log('getAllRooms å–å¾—æˆ¿é–“æ•¸é‡:', rooms.length);
        return rooms;
    }

    // ---------- å»ºç«‹æˆ¿é–“ ----------
    async function createRoom(roomName, password, creator) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        if (!roomName.trim()) return { success: false, msg: 'è«‹è¼¸å…¥æˆ¿é–“åç¨±' };
        if (password && password.includes(' ')) {
            return { success: false, msg: 'æˆ¿é–“å¯†ç¢¼ä¸å¯åŒ…å«ç©ºæ ¼' };
        }
        let roomId;
        let exists = true;
        let attempts = 0;
        while (exists && attempts < 10) {
            roomId = generateShortId();
            const snap = await database.ref('rooms/' + roomId).once('value');
            exists = snap.exists();
            attempts++;
        }
        if (exists) return { success: false, msg: 'ç„¡æ³•ç”¢ç”Ÿå”¯ä¸€IDï¼Œè«‹é‡è©¦' };
        const newRoom = {
            id: roomId,
            name: roomName.trim(),
            password: password || null,
            createdBy: creator.username,
            createdAt: new Date().toISOString()
        };
        await database.ref('rooms/' + roomId).set(newRoom);
        await database.ref(`roomUsers/${roomId}/${creator.uid}`).set(true);
        return { success: true, room: newRoom };
    }

    // ---------- é€éç·¨è™ŸåŠ å…¥æˆ¿é–“ ----------
    async function joinRoomWithId(roomId, password, uid, isAdmin) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        const roomSnap = await database.ref('rooms/' + roomId).once('value');
        const room = roomSnap.val();
        if (!room) return { success: false, msg: 'æˆ¿é–“ç·¨è™Ÿä¸å­˜åœ¨' };
        if (!isAdmin && room.password && room.password !== password) {
            return { success: false, msg: 'å¯†ç¢¼éŒ¯èª¤' };
        }
        await database.ref(`roomUsers/${roomId}/${uid}`).set(true);
        return { success: true, room };
    }

    // ---------- ç™¼é€è¨Šæ¯ ----------
    async function sendMessage(roomId, uid, content, type = 'text') {
        if (!firebaseReady || !roomId) return;
        if (type === 'text' && !content.trim()) return;
        const now = Date.now();
        if (now - lastMessageTime < MIN_INTERVAL) {
            alert('ç™¼é€å¤ªé »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦');
            return;
        }
        if (type === 'text' && content.length > 15000) {
            alert('æ–‡å­—è¨Šæ¯ä¸èƒ½è¶…é15000å­—å…ƒ');
            return;
        }
        if (type === 'image' && content.length > 40000) {
            alert('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹å£“ç¸®å¾Œå†è©¦');
            return;
        }
        lastMessageTime = now;
        const msgRef = database.ref(`messages/${roomId}`).push();
        await msgRef.set({
            uid: uid,
            content: content,
            type: type,
            timestamp: now
        });
        sentBytes += content.length;
        updateTrafficDisplay();
    }

    // ---------- ç®¡ç†å“¡åˆªé™¤æˆ¿é–“ ----------
    async function deleteRoomByAdmin(roomId) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        await database.ref('rooms/' + roomId).remove();
        await database.ref('roomUsers/' + roomId).remove();
        await database.ref('messages/' + roomId).remove();
        return { success: true };
    }

    // ---------- ç®¡ç†å“¡æ›´æ–°æˆ¿é–“ ----------
    async function updateRoomByAdmin(roomId, newName, newPassword) {
        if (!firebaseReady) return { success: false, msg: 'Firebase æœªåˆå§‹åŒ–' };
        const roomSnap = await database.ref('rooms/' + roomId).once('value');
        const room = roomSnap.val();
        if (!room) return { success: false, msg: 'æˆ¿é–“ä¸å­˜åœ¨' };
        if (newName) room.name = newName.trim();
        room.password = newPassword || null;
        await database.ref('rooms/' + roomId).set(room);
        return { success: true, room };
    }

    // ---------- UI æ¸²æŸ“ ----------
    async function renderRoomList() {
        if (!currentUser) return;
        const isAdmin = currentUser.isAdmin;
        let rooms = isAdmin
            ? (adminRoomViewMode === 'all' ? await getAllRooms() : await getAccessibleRoomsForUser(currentUser.uid))
            : await getAccessibleRoomsForUser(currentUser.uid);
        console.log('renderRoomList å–å¾—æˆ¿é–“æ•¸é‡:', rooms.length, 'æ¨¡å¼:', adminRoomViewMode);
        const container = document.getElementById('roomListContainer');
        const hint = document.getElementById('roomListHint');
        if (isAdmin) {
            hint.innerHTML = adminRoomViewMode === 'all'
                ? '<i class="fas fa-eye mr-1"></i>ç®¡ç†å“¡ Â· æ‰€æœ‰æˆ¿é–“'
                : '<i class="fas fa-user mr-1"></i>ç®¡ç†å“¡ Â· æˆ‘çš„æˆ¿é–“';
        } else {
            hint.innerHTML = `<i class="fas fa-user mr-1"></i>${currentUser.username} çš„å¯å­˜å–æˆ¿é–“`;
        }
        if (rooms.length === 0) {
            container.innerHTML = '<div class="text-gray-400 text-sm p-4 text-center">æš«ç„¡æˆ¿é–“ï¼Œå»ºç«‹æˆ–åŠ å…¥ä¸€å€‹å§</div>';
            return;
        }
        let html = '';
        rooms.forEach(room => {
            let isLocked = !!room.password;
            let activeClass = (currentRoomId === room.id) ? 'active' : '';
            let lockIcon = isLocked ? '<i class="fas fa-lock text-amber-500 ml-1 text-xs"></i>' : '';
            html += `<div data-room-id="${room.id}" class="room-item flex justify-between items-center p-3 border rounded-lg cursor-pointer transition ${activeClass}">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800 truncate">${escapeHtml(room.name)}</span> ${lockIcon}
                            </div>
                            <div class="text-xs text-gray-500 truncate">ID: ${room.id}</div>
                        </div>
                        ${isLocked ? '<span class="text-xs bg-amber-100 px-2 py-1 rounded-full">åŠ å¯†</span>' : ''}
                    </div>`;
        });
        container.innerHTML = html;
        document.querySelectorAll('.room-item').forEach(el => {
            el.addEventListener('click', () => switchRoom(el.dataset.roomId));
        });
    }

    async function switchRoom(roomId) {
        const roomSnap = await database.ref('rooms/' + roomId).once('value');
        const room = roomSnap.val();
        if (!room) return;
        if (currentUser?.isAdmin) {
            await database.ref(`roomUsers/${roomId}/${currentUser.uid}`).set(true);
        }
        if (currentMessageListener) {
            database.ref('messages/' + currentMessageListener).off();
            currentMessageListener = null;
        }
        currentRoomId = room.id;
        await renderRoomList();
        document.getElementById('currentRoomName').innerText = room.name;
        document.getElementById('currentRoomIdSpan').innerText = room.id;
        document.getElementById('roomLockBadge').classList.toggle('hidden', !room.password);
        document.getElementById('memberSubTabBtn').classList.remove('hidden');
        if (currentChatSubTab === 'member') {
            await renderMemberList();
        } else {
            await renderMessages(room.id);
        }
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('exportChatBtn').disabled = false;
        if (window.innerWidth < 768) toggleSidebar(false);
    }

    // ---------- æ–°å¢å–®å‰‡è¨Šæ¯åˆ°åˆ—è¡¨åº•éƒ¨ ----------
    async function appendMessage(msg, key) {
        const container = document.getElementById('messageList');
        const userData = await getUserData(msg.uid);
        const isSelf = msg.uid === currentUser.uid;
        const align = isSelf ? 'justify-end' : 'justify-start';
        const bg = isSelf ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200';
        let contentHtml = msg.type === 'image'
            ? `<img src="${msg.content}" class="chat-image" onclick="event.stopPropagation(); document.getElementById('modalImage').src='${msg.content}'; document.getElementById('imageModal').classList.remove('hidden');" alt="åœ–ç‰‡è¨Šæ¯">`
            : `<p class="text-sm break-words">${escapeHtml(msg.content) || ' '}</p>`;
        let deleteBtn = (currentUser?.isAdmin) ?
            `<button class="delete-msg-btn ml-2 text-red-400 hover:text-red-600" title="åˆªé™¤è¨Šæ¯" data-room-id="${currentRoomId}" data-msg-id="${key}"><i class="fas fa-trash-alt"></i></button>` : '';
        let avatarImg = `<img src="${userData.avatar}" class="avatar-sm" onerror="this.src='${DEFAULT_AVATAR}'">`;
        const div = document.createElement('div');
        div.id = 'msg-' + key;
        div.dataset.uid = msg.uid;
        div.dataset.key = key;
        div.className = `flex ${align} items-end gap-2 mb-2`;
        div.innerHTML = `
            ${!isSelf ? `<div class="flex-shrink-0">${avatarImg}</div>` : ''}
            <div class="max-w-[70%]">
                <div class="flex items-end gap-2">
                    ${!isSelf ? '<span class="text-xs text-gray-600 font-medium msg-username">'+escapeHtml(userData.username)+'</span>' : ''}
                    <div class="px-4 py-2 rounded-2xl shadow-sm ${bg} flex items-center">
                        ${contentHtml}
                        ${deleteBtn}
                    </div>
                    ${isSelf ? `<div class="flex-shrink-0">${avatarImg}</div>` : ''}
                </div>
                <p class="text-xs text-gray-400 mt-1 ${isSelf ? 'text-right' : 'text-left'}">${new Date(msg.timestamp).toLocaleTimeString()}</p>
            </div>
        `;
        container.appendChild(div);
        if (deleteBtn) {
            div.querySelector('.delete-msg-btn').addEventListener('click', async (e) => {
                e.stopPropagation();
                const roomId = e.currentTarget.dataset.roomId;
                const msgId = e.currentTarget.dataset.msgId;
                if (confirm('ç¢ºå®šåˆªé™¤é€™å‰‡è¨Šæ¯å—ï¼Ÿ')) {
                    await database.ref(`messages/${roomId}/${msgId}`).remove();
                    div.remove();
                }
            });
        }
    }

    // ---------- è¼‰å…¥è¨Šæ¯æ‰¹æ¬¡ï¼ˆåˆ†é ï¼‰----------
    async function loadMessages(reset = true) {
        if (!currentRoomId || !firebaseReady) return;
        if (loadingMore) return;
        loadingMore = true;

        const container = document.getElementById('messageList');
        const roomId = currentRoomId;

        let query = database.ref('messages/' + roomId).orderByKey();
        if (reset) {
            query = query.limitToLast(MESSAGE_LIMIT);
        } else {
            if (!lastMessageKey) {
                loadingMore = false;
                return;
            }
            query = query.endBefore(lastMessageKey).limitToLast(MESSAGE_LIMIT);
        }

        try {
            const snapshot = await query.once('value');
            const msgs = [];
            snapshot.forEach(child => msgs.push({ key: child.key, ...child.val() }));
            
            msgs.sort((a, b) => a.key.localeCompare(b.key));

            if (reset) {
                container.innerHTML = '';
                lastMessageKey = msgs.length > 0 ? msgs[0].key : null;
                hasMoreMessages = msgs.length === MESSAGE_LIMIT;
                for (let msg of msgs) {
                    await appendMessage(msg, msg.key);
                }
                if (msgs.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 text-sm mt-10">âœ¨ æš«ç„¡è¨Šæ¯ï¼Œç™¼é€ç¬¬ä¸€æ¢å§</div>';
                }
                container.scrollTop = container.scrollHeight;
            } else {
                if (msgs.length > 0) {
                    lastMessageKey = msgs[0].key;
                    hasMoreMessages = msgs.length === MESSAGE_LIMIT;
                    const fragment = document.createDocumentFragment();
                    for (let msg of msgs) {
                        const userData = await getUserData(msg.uid);
                        const isSelf = msg.uid === currentUser.uid;
                        const align = isSelf ? 'justify-end' : 'justify-start';
                        const bg = isSelf ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200';
                        let contentHtml = msg.type === 'image'
                            ? `<img src="${msg.content}" class="chat-image" onclick="event.stopPropagation(); document.getElementById('modalImage').src='${msg.content}'; document.getElementById('imageModal').classList.remove('hidden');" alt="åœ–ç‰‡è¨Šæ¯">`
                            : `<p class="text-sm break-words">${escapeHtml(msg.content) || ' '}</p>`;
                        let deleteBtn = (currentUser?.isAdmin) ?
                            `<button class="delete-msg-btn ml-2 text-red-400 hover:text-red-600" title="åˆªé™¤è¨Šæ¯" data-room-id="${currentRoomId}" data-msg-id="${msg.key}"><i class="fas fa-trash-alt"></i></button>` : '';
                        let avatarImg = `<img src="${userData.avatar}" class="avatar-sm" onerror="this.src='${DEFAULT_AVATAR}'">`;
                        const div = document.createElement('div');
                        div.id = 'msg-' + msg.key;
                        div.dataset.uid = msg.uid;
                        div.dataset.key = msg.key;
                        div.className = `flex ${align} items-end gap-2 mb-2`;
                        div.innerHTML = `
                            ${!isSelf ? `<div class="flex-shrink-0">${avatarImg}</div>` : ''}
                            <div class="max-w-[70%]">
                                <div class="flex items-end gap-2">
                                    ${!isSelf ? '<span class="text-xs text-gray-600 font-medium msg-username">'+escapeHtml(userData.username)+'</span>' : ''}
                                    <div class="px-4 py-2 rounded-2xl shadow-sm ${bg} flex items-center">
                                        ${contentHtml}
                                        ${deleteBtn}
                                    </div>
                                    ${isSelf ? `<div class="flex-shrink-0">${avatarImg}</div>` : ''}
                                </div>
                                <p class="text-xs text-gray-400 mt-1 ${isSelf ? 'text-right' : 'text-left'}">${new Date(msg.timestamp).toLocaleTimeString()}</p>
                            </div>
                        `;
                        fragment.appendChild(div);
                    }
                    const scrollTopBefore = container.scrollTop;
                    const firstChild = container.firstChild;
                    container.insertBefore(fragment, firstChild);
                    if (firstChild) {
                        container.scrollTop = scrollTopBefore + (firstChild.offsetTop - (container.firstChild?.offsetTop || 0));
                    } else {
                        container.scrollTop = 0;
                    }
                } else {
                    hasMoreMessages = false;
                }
            }

            applyChatWallpaper();

            if (reset) {
                if (messageListScrollListener) {
                    container.removeEventListener('scroll', messageListScrollListener);
                }
                messageListScrollListener = async () => {
                    if (container.scrollTop === 0 && hasMoreMessages && !loadingMore) {
                        await loadMessages(false);
                    }
                };
                container.addEventListener('scroll', messageListScrollListener);
            }
        } catch (error) {
            console.error('è¼‰å…¥è¨Šæ¯å¤±æ•—:', error);
        } finally {
            loadingMore = false;
        }
    }

    // ---------- æ¸²æŸ“è¨Šæ¯ï¼ˆå…¥å£ï¼‰----------
    async function renderMessages(roomId) {
        if (currentMessageListener) {
            database.ref('messages/' + currentMessageListener).off();
        }
        currentMessageListener = roomId;

        lastMessageKey = null;
        hasMoreMessages = true;
        loadingMore = false;

        await loadMessages(true);

        database.ref('messages/' + roomId).on('child_added', (snap) => {
            const msg = snap.val();
            const key = snap.key;
            if (!document.getElementById('msg-' + key)) {
                appendMessage(msg, key);
                receivedBytes += msg.content.length;
                updateTrafficDisplay();
                const container = document.getElementById('messageList');
                container.scrollTop = container.scrollHeight;
            }
        });
    }

    async function renderMemberList() {
        if (!currentRoomId) return;
        const members = await getRoomMembers(currentRoomId);
        const container = document.getElementById('memberListContainer');
        if (members.length === 0) {
            container.innerHTML = '<div class="text-gray-400 text-sm p-4 text-center">æš«ç„¡æˆå“¡</div>';
            return;
        }
        let html = '';
        members.forEach(u => {
            const isAdminUser = u.isAdmin ? '<span class="ml-2 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full"><i class="fas fa-crown"></i> ç®¡ç†å“¡</span>' : '';
            html += `<div class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:shadow-sm transition">
                        <img src="${u.avatar || DEFAULT_AVATAR}" class="avatar mr-3" onerror="this.src='${DEFAULT_AVATAR}'">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800">${escapeHtml(u.username)}</span>
                                ${isAdminUser}
                            </div>
                        </div>
                    </div>`;
        });
        container.innerHTML = html;
    }

    async function renderRoomManageList() {
        const searchInput = document.getElementById('roomManageSearch');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        let rooms = await getAllRooms();
        console.log('renderRoomManageList å–å¾—æˆ¿é–“æ•¸é‡:', rooms.length);
        if (searchTerm) rooms = rooms.filter(r => r.name.toLowerCase().includes(searchTerm) || r.id.toLowerCase().includes(searchTerm));
        const container = document.getElementById('roomManageList');
        let html = '';
        for (let room of rooms) {
            html += `<div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex-1">
                            <div class="font-medium">${escapeHtml(room.name)}</div>
                            <div class="text-xs text-gray-500">ID: ${room.id} ${room.password ? 'ğŸ”’' : ''}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-room-btn text-blue-600 hover:text-blue-800" title="ç·¨è¼¯" data-room-id="${room.id}" data-room-name="${escapeHtml(room.name)}" data-room-pwd="${room.password || ''}"><i class="fas fa-edit"></i></button>
                            <button class="delete-room-btn text-red-600 hover:text-red-800" title="åˆªé™¤" data-room-id="${room.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
        }
        container.innerHTML = html || '<p class="text-gray-500 text-center py-4">æ²’æœ‰æ‰¾åˆ°æˆ¿é–“</p>';

        document.querySelectorAll('#roomManageList .edit-room-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const roomId = btn.dataset.roomId, roomName = btn.dataset.roomName, roomPwd = btn.dataset.roomPwd;
                document.getElementById('editRoomName').value = roomName;
                document.getElementById('editRoomPwd').value = roomPwd === 'null' ? '' : roomPwd;
                document.getElementById('editRoomMessage').innerText = '';
                const saveBtn = document.getElementById('editRoomSaveBtn');
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                newSaveBtn.addEventListener('click', async () => {
                    const newName = document.getElementById('editRoomName').value.trim();
                    const newPwd = document.getElementById('editRoomPwd').value.trim();
                    if (!newName) { document.getElementById('editRoomMessage').innerText = 'æˆ¿é–“åç¨±ä¸èƒ½ç‚ºç©º'; return; }
                    const res = await updateRoomByAdmin(roomId, newName, newPwd);
                    if (res.success) {
                        alert('æˆ¿é–“è³‡è¨Šå·²æ›´æ–°');
                        document.getElementById('editRoomModal').classList.add('hidden');
                        await renderRoomManageList();
                        if (currentRoomId === roomId) {
                            document.getElementById('currentRoomName').innerText = newName;
                            document.getElementById('roomLockBadge').classList.toggle('hidden', !newPwd);
                        }
                        await renderRoomList();
                    } else document.getElementById('editRoomMessage').innerText = res.msg;
                });
                document.getElementById('editRoomModal').classList.remove('hidden');
            });
        });

        document.querySelectorAll('#roomManageList .delete-room-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const roomId = btn.dataset.roomId;
                if (!confirm(`ç¢ºå®šåˆªé™¤æˆ¿é–“ ${roomId} å—ï¼Ÿ`)) return;
                const res = await deleteRoomByAdmin(roomId);
                if (res.success) {
                    alert('æˆ¿é–“å·²åˆªé™¤');
                    if (currentRoomId === roomId) {
                        currentRoomId = null;
                        document.getElementById('currentRoomName').innerText = 'æœªé¸æ“‡æˆ¿é–“';
                        document.getElementById('currentRoomIdSpan').innerText = '';
                        document.getElementById('roomLockBadge').classList.add('hidden');
                        document.getElementById('memberSubTabBtn').classList.add('hidden');
                        document.getElementById('messageInput').disabled = true;
                        document.getElementById('sendBtn').disabled = true;
                        document.getElementById('uploadBtn').disabled = true;
                        document.getElementById('exportChatBtn').disabled = true;
                        document.getElementById('messageList').innerHTML = '<div class="text-center text-gray-400 text-sm mt-10">â† å¾å·¦å´é¸æ“‡ä¸€å€‹æˆ¿é–“æˆ–å»ºç«‹æˆ¿é–“</div>';
                        if (currentChatSubTab === 'member') await switchChatSubTab('message');
                    }
                    await renderRoomList();
                    await renderRoomManageList();
                } else alert(res.msg);
            });
        });
    }

    async function renderUserManageList() {
        const searchInput = document.getElementById('userManageSearch');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        let users = await getAllUsers();
        console.log('renderUserManageList å–å¾—ä½¿ç”¨è€…æ•¸é‡:', users.length);
        if (searchTerm) users = users.filter(u => u.username.toLowerCase().includes(searchTerm));
        const container = document.getElementById('userManageList');

        const allowAdminName = await getAdminConfig();
        const checkbox = document.getElementById('allowAdminNameCheckbox');
        if (checkbox) {
            checkbox.checked = allowAdminName;
            const newCheckbox = checkbox.cloneNode(true);
            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            newCheckbox.addEventListener('change', async function(e) {
                const newValue = e.target.checked;
                const res = await setAdminConfig(newValue);
                if (!res.success) {
                    alert(res.msg);
                    e.target.checked = !newValue;
                } else {
                    alert('è¨­å®šå·²æ›´æ–°');
                }
            });
        }

        let html = '';
        for (let u of users) {
            const isAdmin = u.isAdmin ? '<span class="ml-2 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">ç®¡ç†å“¡</span>' : '';
            const bannedClass = u.banned ? 'line-through text-gray-400' : '';
            const bannedBadge = u.banned ? '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">å·²å±è”½</span>' : '';
            let editBtn = '', deleteBtn = '';
            if (u.username !== 'wangsumyuen' && u.username !== currentUser.username) {
                editBtn = `<button class="edit-user-btn ml-2 text-blue-600 hover:text-blue-800" title="ç·¨è¼¯ä½¿ç”¨è€…" data-uid="${u.uid}" data-avatar="${u.avatar || DEFAULT_AVATAR}" data-banned="${u.banned}"><i class="fas fa-edit"></i></button>`;
                deleteBtn = `<button class="delete-user-btn ml-2 text-red-600 hover:text-red-800" title="åˆªé™¤ä½¿ç”¨è€…" data-uid="${u.uid}"><i class="fas fa-trash-alt"></i></button>`;
            }
            html += `<div class="flex items-center p-3 bg-white rounded-lg border border-gray-200 ${bannedClass}">
                        <img src="${u.avatar || DEFAULT_AVATAR}" class="avatar mr-3" onerror="this.src='${DEFAULT_AVATAR}'">
                        <div class="flex-1">
                            <div class="flex items-center flex-wrap">
                                <span class="font-medium">${escapeHtml(u.username)}</span> ${isAdmin} ${bannedBadge}
                            </div>
                            <p class="text-xs text-gray-500">è¨»å†Š: ${new Date(u.createdAt).toLocaleString()}</p>
                        </div>
                        <div class="flex">${editBtn}${deleteBtn}</div>
                    </div>`;
        }
        container.innerHTML = html || '<p class="text-gray-500 text-center py-4">æ²’æœ‰æ‰¾åˆ°ä½¿ç”¨è€…</p>';

        document.querySelectorAll('#userManageList .edit-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const uid = btn.dataset.uid, currentAvatar = btn.dataset.avatar, banned = btn.dataset.banned === 'true';
                document.getElementById('editUserCurrentAvatar').src = currentAvatar;
                document.getElementById('editUserAvatarInput').value = '';
                document.getElementById('editUserBanned').value = banned ? 'true' : 'false';
                document.getElementById('editUserMessage').innerText = '';
                const saveBtn = document.getElementById('editUserSaveBtn');
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                newSaveBtn.addEventListener('click', async () => {
                    let newAvatar = null;
                    if (document.getElementById('editUserAvatarInput').files.length > 0) {
                        const file = document.getElementById('editUserAvatarInput').files[0];
                        if (!file.type.startsWith('image/')) { document.getElementById('editUserMessage').innerText = 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'; return; }
                        if (file.size > 2 * 1024 * 1024) { document.getElementById('editUserMessage').innerText = 'é ­åƒå¤§å°ä¸èƒ½è¶…é2MB'; return; }
                        const compressedBlob = await compressImage(file, 50);
                        newAvatar = await blobToBase64(compressedBlob);
                    }
                    const banned = document.getElementById('editUserBanned').value === 'true';
                    const res = await updateUserByAdmin(uid, newAvatar, banned);
                    if (res.success) {
                        alert('ä½¿ç”¨è€…è³‡è¨Šå·²æ›´æ–°');
                        document.getElementById('editUserModal').classList.add('hidden');
                        await renderUserManageList();
                        if (currentRoomId) await renderMemberList();
                    } else document.getElementById('editUserMessage').innerText = res.msg;
                });
                document.getElementById('editUserModal').classList.remove('hidden');
            });
        });

        document.querySelectorAll('#userManageList .delete-user-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const uid = btn.dataset.uid;
                if (!confirm(`ç¢ºå®šåˆªé™¤ä½¿ç”¨è€… ${uid} å—ï¼Ÿ`)) return;
                const res = await deleteUserByAdmin(uid);
                if (res.success) {
                    alert('ä½¿ç”¨è€…å·²åˆªé™¤');
                    await renderUserManageList();
                    if (currentRoomId) { await renderMemberList(); await renderMessages(currentRoomId); }
                } else alert(res.msg);
            });
        });
    }

    async function switchMainTab(tab) {
        if (!currentUser) return;
        currentMainTab = tab;
        const chatMain = document.getElementById('chatMainArea'), roomMain = document.getElementById('roomManageMainArea'), userMain = document.getElementById('userManageMainArea');
        const chatTab = document.getElementById('chatMainTabBtn'), roomTab = document.getElementById('roomManageMainTabBtn'), userTab = document.getElementById('userManageMainTabBtn');
        chatMain.classList.add('hidden'); roomMain.classList.add('hidden'); userMain.classList.add('hidden');
        [chatTab, roomTab, userTab].forEach(t => { if (t) { t.classList.remove('text-indigo-600', 'border-indigo-600'); t.classList.add('text-gray-500'); } });
        if (tab === 'chat') {
            chatMain.classList.remove('hidden'); chatTab.classList.add('text-indigo-600', 'border-indigo-600');
            if (currentRoomId) { if (currentChatSubTab === 'message') await renderMessages(currentRoomId); else await renderMemberList(); }
        } else if (tab === 'roomManage' && currentUser.isAdmin) {
            roomMain.classList.remove('hidden'); roomTab.classList.add('text-indigo-600', 'border-indigo-600'); await renderRoomManageList();
        } else if (tab === 'userManage' && currentUser.isAdmin) {
            userMain.classList.remove('hidden'); userTab.classList.add('text-indigo-600', 'border-indigo-600'); await renderUserManageList();
        }
    }

    async function switchChatSubTab(subTab) {
        if (!currentUser || currentMainTab !== 'chat') return;
        currentChatSubTab = subTab;
        const messageArea = document.getElementById('messageArea'), memberArea = document.getElementById('memberArea');
        const msgSubTab = document.getElementById('chatSubTabBtn'), memberSubTab = document.getElementById('memberSubTabBtn');
        if (subTab === 'message') {
            messageArea.classList.remove('hidden'); memberArea.classList.add('hidden');
            msgSubTab.classList.add('text-indigo-600', 'border-indigo-600'); memberSubTab.classList.remove('text-indigo-600', 'border-indigo-600');
            if (currentRoomId) await renderMessages(currentRoomId);
        } else {
            messageArea.classList.add('hidden'); memberArea.classList.remove('hidden');
            memberSubTab.classList.add('text-indigo-600', 'border-indigo-600'); msgSubTab.classList.remove('text-indigo-600', 'border-indigo-600');
            if (currentRoomId) await renderMemberList();
        }
    }

    function updateAdminToggleUI() {
        if (!currentUser?.isAdmin) return;
        const myBtn = document.getElementById('showMyRoomsBtn'), allBtn = document.getElementById('showAllRoomsBtn');
        if (adminRoomViewMode === 'my') {
            myBtn.classList.add('bg-indigo-100', 'text-indigo-700'); myBtn.classList.remove('bg-gray-100', 'text-gray-700');
            allBtn.classList.add('bg-gray-100', 'text-gray-700'); allBtn.classList.remove('bg-indigo-100', 'text-indigo-700');
        } else {
            allBtn.classList.add('bg-indigo-100', 'text-indigo-700'); allBtn.classList.remove('bg-gray-100', 'text-gray-700');
            myBtn.classList.add('bg-gray-100', 'text-gray-700'); myBtn.classList.remove('bg-indigo-100', 'text-indigo-700');
        }
    }

    window.toggleSidebar = function(force) {
        const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebarOverlay');
        if (force !== undefined) {
            if (force) { sidebar.classList.add('open'); overlay.classList.add('open'); }
            else { sidebar.classList.remove('open'); overlay.classList.remove('open'); }
        } else { sidebar.classList.toggle('open'); overlay.classList.toggle('open'); }
    };

    async function logout() {
        currentUser = null; currentRoomId = null; adminRoomViewMode = 'my'; currentMainTab = 'chat'; currentChatSubTab = 'message';
        document.getElementById('chatPage').classList.add('hidden'); document.getElementById('loginPage').classList.remove('hidden');
        if (currentMessageListener) database.ref('messages/' + currentMessageListener).off();
        if (messageListScrollListener) {
            document.getElementById('messageList')?.removeEventListener('scroll', messageListScrollListener);
            messageListScrollListener = null;
        }
        document.getElementById('imageUploadInput').value = ''; document.getElementById('memberSubTabBtn').classList.add('hidden');
        toggleSidebar(false); sentBytes = 0; receivedBytes = 0; updateTrafficDisplay();
    }

    async function showChat(user) {
        currentUser = user; adminRoomViewMode = 'my'; currentMainTab = 'chat'; currentChatSubTab = 'message';
        document.getElementById('loginPage').classList.add('hidden'); document.getElementById('chatPage').classList.remove('hidden');
        document.getElementById('navUsername').innerText = user.username;
        const navAvatar = document.getElementById('navAvatar'); navAvatar.src = user.avatar || DEFAULT_AVATAR; navAvatar.classList.remove('hidden');
        navAvatar.onerror = () => { navAvatar.src = DEFAULT_AVATAR; };
        const toggleDiv = document.getElementById('adminRoomToggle'), roomManageTab = document.getElementById('roomManageMainTabBtn'), userManageTab = document.getElementById('userManageMainTabBtn');
        if (user.isAdmin) {
            toggleDiv.classList.remove('hidden'); roomManageTab.classList.remove('hidden'); userManageTab.classList.remove('hidden');
            document.getElementById('adminBadge').classList.remove('hidden'); updateAdminToggleUI();
        } else {
            toggleDiv.classList.add('hidden'); roomManageTab.classList.add('hidden'); userManageTab.classList.add('hidden');
            document.getElementById('adminBadge').classList.add('hidden');
        }
        document.getElementById('memberSubTabBtn').classList.add('hidden');
        await switchMainTab('chat'); currentRoomId = null; await renderRoomList();
        document.getElementById('messageInput').disabled = true; document.getElementById('sendBtn').disabled = true;
        document.getElementById('uploadBtn').disabled = true; document.getElementById('exportChatBtn').disabled = true;
        document.getElementById('messageList').innerHTML = '<div class="text-center text-gray-400 text-sm mt-10">â† å¾å·¦å´é¸æ“‡ä¸€å€‹æˆ¿é–“æˆ–å»ºç«‹æˆ¿é–“</div>';
        document.getElementById('currentRoomName').innerText = 'æœªé¸æ“‡æˆ¿é–“'; document.getElementById('currentRoomIdSpan').innerText = '';
        document.getElementById('roomLockBadge').classList.add('hidden');
        applyChatWallpaper();
    }

    // äº‹ä»¶ç¶å®šï¼ˆé‡é»ï¼šè¨»å†ŠæŒ‰éˆ•çš„éŒ¯èª¤è™•ç†å·²åŠ å¼·ï¼‰
    function bindEvents() {
        // ç™»å…¥/è¨»å†Šé ç±¤åˆ‡æ›
        document.getElementById('loginTabBtn').addEventListener('click', function(){
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            this.classList.add('text-indigo-600', 'border-indigo-600');
            document.getElementById('registerTabBtn').classList.remove('text-indigo-600', 'border-indigo-600');
            document.getElementById('registerTabBtn').classList.add('text-gray-500');
        });
        document.getElementById('registerTabBtn').addEventListener('click', function(){
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            this.classList.add('text-indigo-600', 'border-indigo-600');
            document.getElementById('loginTabBtn').classList.remove('text-indigo-600', 'border-indigo-600');
            document.getElementById('loginTabBtn').classList.add('text-gray-500');
        });

        // é ­åƒä¸Šå‚³
        const regAvatarBtn = document.getElementById('regAvatarBtn'), regAvatarInput = document.getElementById('regAvatarInput'), avatarFileName = document.getElementById('avatarFileName'), avatarPreviewContainer = document.getElementById('avatarPreviewContainer'), avatarPreviewImg = document.getElementById('avatarPreviewImg');
        regAvatarBtn.addEventListener('click', () => regAvatarInput.click());
        regAvatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) { avatarFileName.innerText = 'æœªé¸æ“‡æª”æ¡ˆ'; avatarPreviewContainer.classList.add('hidden'); return; }
            avatarFileName.innerText = file.name;
            const reader = new FileReader(); reader.onload = (ev) => { avatarPreviewImg.src = ev.target.result; avatarPreviewContainer.classList.remove('hidden'); }; reader.readAsDataURL(file);
        });

        // è¨»å†ŠæŒ‰éˆ•ï¼ˆå·²åŠ å…¥æ›´è©³ç´°çš„éŒ¯èª¤æç¤ºï¼‰
        document.getElementById('registerBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;

            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            let avatarBase64 = null;

            // å‰ç«¯é©—è­‰
            if (!username || !password) {
                document.getElementById('registerError').innerText = 'è«‹å¡«å¯«ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼';
                return;
            }
            if (username.includes(' ') || password.includes(' ')) {
                document.getElementById('registerError').innerText = 'ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼ä¸å¯åŒ…å«ç©ºæ ¼';
                return;
            }
            if (password.length < 6) {
                document.getElementById('registerError').innerText = 'å¯†ç¢¼é•·åº¦è‡³å°‘ç‚º6å€‹å­—å…ƒ';
                return;
            }

            // è™•ç†é ­åƒï¼ˆå¦‚æœæœ‰ï¼‰
            if (regAvatarInput.files.length > 0) {
                const file = regAvatarInput.files[0];
                if (!file.type.startsWith('image/')) { 
                    document.getElementById('registerError').innerText = 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ';
                    return;
                }
                if (file.size > 2 * 1024 * 1024) { 
                    document.getElementById('registerError').innerText = 'é ­åƒå¤§å°ä¸èƒ½è¶…é2MB';
                    return;
                }
                try {
                    const compressedBlob = await compressImage(file, 50);
                    avatarBase64 = await blobToBase64(compressedBlob);
                } catch (err) {
                    console.error('åœ–ç‰‡è™•ç†éŒ¯èª¤:', err);
                    document.getElementById('registerError').innerText = 'åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    return;
                }
            }

            // é¡¯ç¤ºè¨»å†Šä¸­ç‹€æ…‹
            const registerBtn = document.getElementById('registerBtn');
            const originalText = registerBtn.innerText;
            registerBtn.innerText = 'è¨»å†Šä¸­...';
            registerBtn.disabled = true;
            document.getElementById('registerError').innerText = ''; // æ¸…é™¤èˆŠéŒ¯èª¤

            try {
                const res = await registerUser(username, password, avatarBase64);
                
                if (res.success) {
                    alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
                    // åˆ‡æ›åˆ°ç™»å…¥é ç±¤ä¸¦é å¡«ä½¿ç”¨è€…åç¨±
                    document.getElementById('loginTabBtn').click();
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = '';
                    // æ¸…ç©ºè¨»å†Šè¡¨å–®
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regPassword').value = '';
                    regAvatarInput.value = '';
                    avatarFileName.innerText = 'æœªé¸æ“‡æª”æ¡ˆ';
                    avatarPreviewContainer.classList.add('hidden');
                    document.getElementById('registerError').innerText = '';
                } else {
                    document.getElementById('registerError').innerText = res.msg;
                    // è‹¥éŒ¯èª¤è¨Šæ¯ä¸æ˜ç¢ºï¼Œå¯åŠ ä¸Š alert è¼”åŠ©
                    if (res.msg.includes('network') || res.msg.includes('ç¶²è·¯')) {
                        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·šå¾Œå†è©¦ã€‚');
                    }
                }
            } catch (unexpectedError) {
                console.error('è¨»å†Šéç¨‹ç™¼ç”Ÿæœªé æœŸéŒ¯èª¤:', unexpectedError);
                document.getElementById('registerError').innerText = 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                alert('è¨»å†Šå¤±æ•—ï¼š' + unexpectedError.message);
            } finally {
                registerBtn.innerText = originalText;
                registerBtn.disabled = false;
            }
        });

        // ç™»å…¥æŒ‰éˆ•
        document.getElementById('loginBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            let username = document.getElementById('loginUsername').value.trim(), password = document.getElementById('loginPassword').value.trim();
            let res = await loginUser(username, password);
            if (res.success) {
                await showChat(res.user);
                document.getElementById('loginError').innerText = '';
            } else {
                document.getElementById('loginError').innerText = res.msg;
            }
        });

        // ç™»å‡ºæŒ‰éˆ•
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // å»ºç«‹æˆ¿é–“
        document.getElementById('createRoomBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
            let roomName = document.getElementById('newRoomName').value.trim(), pwd = document.getElementById('newRoomPwd').value.trim() || null;
            let res = await createRoom(roomName, pwd, currentUser);
            if (res.success) {
                console.log('å»ºç«‹æˆ¿é–“æˆåŠŸ', res.room);
                document.getElementById('newRoomName').value = '';
                document.getElementById('newRoomPwd').value = '';
                await renderRoomList();
                await switchRoom(res.room.id);
                if (window.innerWidth < 768) toggleSidebar(false);
            } else alert(res.msg);
        });

        // é€éç·¨è™ŸåŠ å…¥æˆ¿é–“
        document.getElementById('joinRoomBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
            let roomId = document.getElementById('joinRoomId').value.trim(), pwd = document.getElementById('joinRoomPwd').value.trim();
            if (!roomId) { alert('è«‹è¼¸å…¥æˆ¿é–“ç·¨è™Ÿ'); return; }
            let res = await joinRoomWithId(roomId, pwd, currentUser.uid, currentUser.isAdmin);
            if (res.success) {
                console.log('åŠ å…¥æˆ¿é–“æˆåŠŸ', res.room);
                document.getElementById('joinRoomId').value = '';
                document.getElementById('joinRoomPwd').value = '';
                await renderRoomList();
                await switchRoom(res.room.id);
                if (window.innerWidth < 768) toggleSidebar(false);
            } else alert(res.msg);
        });

        // ç™¼é€è¨Šæ¯
        document.getElementById('sendBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            let msg = document.getElementById('messageInput').value;
            if (!currentRoomId || !msg.trim() || !currentUser) return;
            await sendMessage(currentRoomId, currentUser.uid, msg, 'text');
            document.getElementById('messageInput').value = '';
        });
        document.getElementById('messageInput').addEventListener('keypress', function(e){ if (e.key === 'Enter') document.getElementById('sendBtn').click(); });

        // ä¸Šå‚³åœ–ç‰‡
        const uploadBtn = document.getElementById('uploadBtn'), fileInput = document.getElementById('imageUploadInput');
        uploadBtn.addEventListener('click', function(){ if (!currentRoomId) { alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æˆ¿é–“'); return; } fileInput.click(); });
        fileInput.addEventListener('change', async function(e) {
            if (!checkFirebaseReady()) return;
            const file = e.target.files[0]; if (!file) return;
            if (!file.type.startsWith('image/')) { alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'); fileInput.value = ''; return; }
            if (file.size > 2 * 1024 * 1024) { alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é2MB'); fileInput.value = ''; return; }
            const compressedBlob = await compressImage(file, 50);
            const reader = new FileReader(); reader.readAsDataURL(compressedBlob);
            reader.onload = async (event) => { await sendMessage(currentRoomId, currentUser.uid, event.target.result, 'image'); fileInput.value = ''; };
        });

        // ç®¡ç†å“¡æˆ¿é–“è¦–åœ–åˆ‡æ›
        document.getElementById('showMyRoomsBtn').addEventListener('click', async function(){
            if (!currentUser?.isAdmin) return; adminRoomViewMode = 'my'; updateAdminToggleUI(); await renderRoomList();
        });
        document.getElementById('showAllRoomsBtn').addEventListener('click', async function(){
            if (!currentUser?.isAdmin) return; adminRoomViewMode = 'all'; updateAdminToggleUI(); await renderRoomList();
        });

        // ä¸»æ¨™ç±¤åˆ‡æ›
        document.getElementById('chatMainTabBtn').addEventListener('click', async function(){ await switchMainTab('chat'); });
        document.getElementById('roomManageMainTabBtn').addEventListener('click', async function(){ if (!currentUser?.isAdmin) return; await switchMainTab('roomManage'); });
        document.getElementById('userManageMainTabBtn').addEventListener('click', async function(){ if (!currentUser?.isAdmin) return; await switchMainTab('userManage'); });

        // èŠå¤©å­æ¨™ç±¤åˆ‡æ›
        document.getElementById('chatSubTabBtn').addEventListener('click', async function(){ await switchChatSubTab('message'); });
        document.getElementById('memberSubTabBtn').addEventListener('click', async function(){ if (!currentRoomId) { alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æˆ¿é–“'); return; } await switchChatSubTab('member'); });

        // åŒ¯å‡ºèŠå¤©è¨˜éŒ„
        document.getElementById('exportChatBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            if (!currentRoomId) { alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æˆ¿é–“'); return; }
            await exportRoomMessages(currentRoomId);
        });

        // å´é‚Šæ¬„é–‹é—œ
        document.getElementById('menuToggleBtn').addEventListener('click', function(){ toggleSidebar(); });
        document.getElementById('sidebarOverlay').addEventListener('click', function(){ toggleSidebar(false); });

        // ä¿®æ”¹è³‡æ–™ (å«å£ç´™)
        const profileModal = document.getElementById('profileModal'), editProfileBtn = document.getElementById('editProfileBtn'), profileCancelBtn = document.getElementById('profileCancelBtn'), profileSaveBtn = document.getElementById('profileSaveBtn'), profileCurrentAvatar = document.getElementById('profileCurrentAvatar'), profileAvatarInput = document.getElementById('profileAvatarInput'), profileNewUsername = document.getElementById('profileNewUsername'), profileUsernameMessage = document.getElementById('profileUsernameMessage'), profileOldPwd = document.getElementById('profileOldPwd'), profileNewPwd = document.getElementById('profileNewPwd'), profileConfirmPwd = document.getElementById('profileConfirmPwd'), profileMessage = document.getElementById('profileMessage'), profileWallpaperColor = document.getElementById('profileWallpaperColor'), profileWallpaperImage = document.getElementById('profileWallpaperImage'), clearWallpaperBtn = document.getElementById('clearWallpaperBtn');
        
        editProfileBtn.addEventListener('click', function(){
            if (!currentUser) return;
            profileCurrentAvatar.src = currentUser.avatar || DEFAULT_AVATAR; profileNewUsername.value = ''; profileUsernameMessage.innerText = '';
            profileOldPwd.value = ''; profileNewPwd.value = ''; profileConfirmPwd.value = ''; profileAvatarInput.value = ''; profileMessage.innerText = '';
            if (currentUser.wallpaper) {
                if (currentUser.wallpaper.startsWith('#')) {
                    profileWallpaperColor.value = currentUser.wallpaper;
                }
            } else {
                profileWallpaperColor.value = DEFAULT_WALLPAPER;
            }
            profileWallpaperImage.value = '';
            profileModal.classList.remove('hidden');
        });

        profileCancelBtn.addEventListener('click', function(){ profileModal.classList.add('hidden'); });

        profileSaveBtn.addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            let oldPwd = profileOldPwd.value.trim(), newUsername = profileNewUsername.value.trim() || null, newPwd = profileNewPwd.value.trim() || null, confirmPwd = profileConfirmPwd.value.trim();
            if (!oldPwd) { profileMessage.innerText = 'è«‹è¼¸å…¥åŸå¯†ç¢¼'; return; }
            if (newPwd && newPwd !== confirmPwd) { profileMessage.innerText = 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´'; return; }
            let newAvatar = null;
            if (profileAvatarInput.files.length > 0) {
                const file = profileAvatarInput.files[0];
                if (!file.type.startsWith('image/')) { profileMessage.innerText = 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'; return; }
                if (file.size > 2 * 1024 * 1024) { profileMessage.innerText = 'é ­åƒå¤§å°ä¸èƒ½è¶…é2MB'; return; }
                const compressedBlob = await compressImage(file, 50);
                newAvatar = await blobToBase64(compressedBlob);
            }

            let newWallpaper = undefined;
            if (profileWallpaperImage.files.length > 0) {
                const file = profileWallpaperImage.files[0];
                if (!file.type.startsWith('image/')) { profileMessage.innerText = 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'; return; }
                if (file.size > 2 * 1024 * 1024) { profileMessage.innerText = 'èƒŒæ™¯åœ–ç‰‡ä¸èƒ½è¶…é2MB'; return; }
                const compressedBlob = await compressImage(file, 200);
                newWallpaper = await blobToBase64(compressedBlob);
            } else {
                newWallpaper = profileWallpaperColor.value;
            }

            async function performUpdate() {
                const res = await updateUserProfile(currentUser.uid, oldPwd, newUsername, newPwd, newAvatar, newWallpaper);
                if (res.success) {
                    alert('è³‡æ–™ä¿®æ”¹æˆåŠŸ'); currentUser = res.user;
                    document.getElementById('navAvatar').src = currentUser.avatar || DEFAULT_AVATAR; document.getElementById('navUsername').innerText = currentUser.username;
                    profileModal.classList.add('hidden');
                    if (newUsername) updateUserCache(currentUser.uid, { username: newUsername });
                    if (newAvatar) updateUserCache(currentUser.uid, { avatar: newAvatar });
                    if (newWallpaper !== undefined) updateUserCache(currentUser.uid, { wallpaper: newWallpaper });
                    if (currentRoomId) { 
                        if (currentChatSubTab === 'member') await renderMemberList(); 
                        else await renderMessages(currentRoomId);
                    }
                    applyChatWallpaper();
                } else profileMessage.innerText = res.msg;
            }
            await performUpdate();
        });

        clearWallpaperBtn.addEventListener('click', function() {
            profileWallpaperColor.value = DEFAULT_WALLPAPER;
            profileWallpaperImage.value = '';
        });

        profileModal.addEventListener('click', function(e){ if (e.target === profileModal) profileModal.classList.add('hidden'); });

        // æ–°å¢æˆ¿é–“
        document.getElementById('addRoomBtn').addEventListener('click', function(){
            if (!checkFirebaseReady()) return;
            document.getElementById('addRoomName').value = ''; document.getElementById('addRoomPwd').value = ''; document.getElementById('addRoomMessage').innerText = ''; document.getElementById('addRoomModal').classList.remove('hidden');
        });
        document.getElementById('addRoomCancelBtn').addEventListener('click', function(){ document.getElementById('addRoomModal').classList.add('hidden'); });
        document.getElementById('addRoomSaveBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            let roomName = document.getElementById('addRoomName').value.trim(), pwd = document.getElementById('addRoomPwd').value.trim() || null;
            if (!roomName) { document.getElementById('addRoomMessage').innerText = 'æˆ¿é–“åç¨±ä¸èƒ½ç‚ºç©º'; return; }
            let res = await createRoom(roomName, pwd, currentUser);
            if (res.success) {
                alert('æˆ¿é–“å»ºç«‹æˆåŠŸ'); document.getElementById('addRoomModal').classList.add('hidden');
                await renderRoomManageList(); await renderRoomList();
            } else document.getElementById('addRoomMessage').innerText = res.msg;
        });

        // æ–°å¢ä½¿ç”¨è€…
        document.getElementById('addUserBtn').addEventListener('click', function(){
            if (!checkFirebaseReady()) return;
            document.getElementById('addUsername').value = ''; document.getElementById('addPassword').value = ''; document.getElementById('addAvatarInput').value = '';
            document.getElementById('addAvatarPreviewContainer').classList.add('hidden'); document.getElementById('addUserMessage').innerText = ''; document.getElementById('addUserModal').classList.remove('hidden');
        });
        document.getElementById('addUserCancelBtn').addEventListener('click', function(){ document.getElementById('addUserModal').classList.add('hidden'); });
        document.getElementById('addUserSaveBtn').addEventListener('click', async function(){
            if (!checkFirebaseReady()) return;
            let username = document.getElementById('addUsername').value.trim(), password = document.getElementById('addPassword').value.trim();
            if (!username || !password) { document.getElementById('addUserMessage').innerText = 'ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼ä¸èƒ½ç‚ºç©º'; return; }
            let avatarBase64 = null;
            if (document.getElementById('addAvatarInput').files.length > 0) {
                const file = document.getElementById('addAvatarInput').files[0];
                if (!file.type.startsWith('image/')) { document.getElementById('addUserMessage').innerText = 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ'; return; }
                if (file.size > 2 * 1024 * 1024) { document.getElementById('addUserMessage').innerText = 'é ­åƒå¤§å°ä¸èƒ½è¶…é2MB'; return; }
                const compressedBlob = await compressImage(file, 50);
                avatarBase64 = await blobToBase64(compressedBlob);
            }
            let res = await registerUser(username, password, avatarBase64);
            if (res.success) { alert('ä½¿ç”¨è€…å»ºç«‹æˆåŠŸ'); document.getElementById('addUserModal').classList.add('hidden'); await renderUserManageList(); }
            else document.getElementById('addUserMessage').innerText = res.msg;
        });

        // æœå°‹è¼¸å…¥
        document.getElementById('roomManageSearch').addEventListener('input', async () => { if (currentMainTab === 'roomManage') await renderRoomManageList(); });
        document.getElementById('userManageSearch').addEventListener('input', async () => { if (currentMainTab === 'userManage') await renderUserManageList(); });

        // ç·¨è¼¯æˆ¿é–“å–æ¶ˆ
        document.getElementById('editRoomCancelBtn').addEventListener('click', function(){ document.getElementById('editRoomModal').classList.add('hidden'); });
        document.getElementById('editRoomModal').addEventListener('click', function(e){ if (e.target === document.getElementById('editRoomModal')) document.getElementById('editRoomModal').classList.add('hidden'); });
        document.getElementById('editUserCancelBtn').addEventListener('click', function(){ document.getElementById('editUserModal').classList.add('hidden'); });
        document.getElementById('editUserModal').addEventListener('click', function(e){ if (e.target === document.getElementById('editUserModal')) document.getElementById('editUserModal').classList.add('hidden'); });
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    if (firebaseReady) {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const snapshot = await database.ref('users/' + user.uid).once('value');
                const userData = snapshot.val();
                if (userData && !userData.banned) {
                    currentUser = { ...userData, uid: user.uid };
                    userCache[user.uid] = { username: userData.username, avatar: userData.avatar || DEFAULT_AVATAR, wallpaper: userData.wallpaper || null };
                    showChat(currentUser);
                } else {
                    auth.signOut();
                }
            } else {
                showLogin();
            }
        });
    } else {
        console.log('Firebase æœªå°±ç·’ï¼Œç„¡æ³•ç›£è½ç™»å…¥ç‹€æ…‹');
    }

    function showLogin() {
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('chatPage').classList.add('hidden');
        currentUser = null;
        currentRoomId = null;
    }

    bindEvents();
})();
</script>
</body>
</html>